name: 综合每日报告推送

on:
  schedule:
    # UTC 23:00 = 北京时间 7:00 AM
    - cron: '00 23 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  send-report:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TZ: Asia/Shanghai
      PYTHONUNBUFFERED: 1
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        
    - name: Install dependencies (fresh install, no cache)
      run: |
        python -m pip install --upgrade pip
        pip cache purge
        pip install -r requirements.txt --force-reinstall --no-cache-dir
        
    - name: Verify packages
      run: |
        python -c "import numpy; print(f'numpy: {numpy.__version__}')"
        python -c "import pandas; print(f'pandas: {pandas.__version__}')"
        python -c "import akshare; print(f'akshare: {akshare.__version__}')"
        
    - name: Run comprehensive report
      run: |
        echo "🚀 开始执行综合每日报告..."
        python comprehensive_report.py
        echo "✅ 综合每日报告执行完成"
      env:
        APP_ID: ${{ secrets.APP_ID }}
        APP_SECRET: ${{ secrets.APP_SECRET }}
        OPEN_ID: ${{ secrets.OPEN_ID }}
        TEMPLATE_ID: ${{ secrets.TEMPLATE_ID }}
        TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
        HEFENG_KEY: ${{ secrets.HEFENG_KEY }}
        HEFENG_HOST: ${{ secrets.HEFENG_HOST }}
        HEFENG_PROJECT_ID: ${{ secrets.HEFENG_PROJECT_ID }}